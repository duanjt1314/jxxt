<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>主界面测试</title>
    <link rel="Shortcut Icon" href="/Content/Images/login/top.ico" />
    <script src="/Content/Script/include_all.js" type="text/javascript"></script>
    <script src="/Content/Script/ExtJs/ux/MainMenu.js" type="text/javascript"></script>
    <script src="/Content/Function/Default/UpdatePass.js" type="text/javascript"></script>
    <script type="text/javascript">

        var treeStore = Ext.create("Ext.data.TreeStore", {
            fields: ["id", "text", "Tobject", "leaf"],
            root: {
                expanded: true,
                text: '配置类型',
                id: 0
            },
            proxy: {
                type: 'ajax',
                url: '/Module/SelectAll'
            }
        });

        var centerPanel = Ext.create("Ext.tab.Panel", {
            region: "center",
            items: [
                {
                    title: '首页',
                    html: "<iframe width='100%' height='100%' frameborder='0' src='/HTML/index.htm'></iframe>"
                },
            ]
        });

        var myMask = new Ext.LoadMask(centerPanel, { msg: '正在努力加载...' });

        var tree = Ext.create("Ext.ux.MainMenu", {
            width: 220,
            region: 'west',
            split: true,
            collapsed: false,
            collapsible: true,
            title: '菜单',
            listeners: {
                itemclick: function (record) {
                    var data = record.get("Tobject");
                    AddShow(data.ModuleName, data.ModuleUrl);
                }
            }
        });

        var southPanel = Ext.create("Ext.panel.Panel", {
            region: "south",
            height: 50,
            border: 1,
            margin: '5 0 0 0',
            html: "<div style='height:50px;text-align:center;line-height:50px;background-color:#6C9DFC;color:white'>Copyright © 2011-2014 段江涛 V3.1.3</div>"
        });

        var northPanel = Ext.create("Ext.panel.Panel", {
            region: "north",
            border: 1,
            margin: '0 0 5 0',
            height: 50,
            loader: {
                url: '/HTML/top.htm',
                autoLoad: true
            }
        });

        Ext.onReady(function () {
            Ext.create("Ext.container.Viewport", {
                layout: "border",
                padding: '5',
                items: [tree, centerPanel, southPanel, northPanel]
            });

            GetCurrentUser();
        });

        //增加选项卡
        function AddShow(name, url) {
            var tab = Ext.getCmp('tab_' + url);
            if (!tab) {
                var layout = Ext.create("Life.Income.Grid", {});
                var b = centerPanel.add({
                    id: "tab_" + url,
                    title: name,
                    layout: 'fit',
                    closable: true,
                    items: [layout]
                });
                b.show();
            } else {
                Ext.getCmp('tab_' + url).show();
            }

        }

        //获得当前用户
        function GetCurrentUser() {
            Ext.Ajax.request({
                url: '/Manage/GetCurrentUser',
                success: function (response) {
                    var data = Ext.JSON.decode(response.responseText);
                    Ext.get("labCurrentName").dom.innerHTML = data.Name;
                }
            })
        }

        //退出登录
        function ExitLogin() {
            Ext.Ajax.request({
                url: '/Manage/ExitLogin',
                success: function (response) {
                    var data = Ext.JSON.decode(response.responseText);
                    if (data.success) {
                        //清空cookie，跳转页面
                        Duanjt.Cookie.Remove("LifeLogin", "/"); //清空cookie的方法就是将cookie的失效期设置为当前日期之前
                        location.href = "/Manage/Index";
                    } else
                        Ext.Msg.alert("提示", data.msg);
                }
            })
        }
        /***************修改密码******************/
        //修改密码
        function UpdatePass() {
            Ext.getCmp("updatePassForm").getForm().reset();
            updatePassWin.show();
        }
    </script>
</head>
<body>
</body>
</html>
